{# <?php #}

	/* UPDATE[{%for verb in methods %}{%if not loop.first%}|{%endif%}{{verb}}{%endfor%}] */
	public function {{action}}Action()
	{
		$request = $this->getRequest();
		// SanityCheck: BAD REQUEST
		//if (! ({{conditions}}) ) {
		//	return $this->redirect()->toRoute('{{module|slugify}}', ['action' => '{{action}}']);// statement list; flashMessage select a statement to add operation manualy
		//}

{%for key, table in entity.dbPKColumns %}
		${{key}} = (int) $this->params()->fromRoute('id', 0);
{% endfor %}
		//$country_id = (int) $this->params()->fromRoute('id_parent', 0);

		$form = new {{entity.name}}Form(False, 'update_{{action}}');
		$form->get('submit')->setValue('Edit');
		//$form->get('statements_id')->setValue($route_statements_id);// error if POST exist

		if ($request->isPost()) {
			{{entity.name|variabilize}} = new {{entity.name}}();
			//$form->setHydrator(new ClassMethodsHydrator());
			$form->bind({{entity.name|variabilize}});
			$inputFilter = {{entity.name|variabilize}}->getInputFilter(False, True);// hasPrimaryKey=False
			$form->setInputFilter($inputFilter);
			$form->setData($request->getPost());

			if ($form->isValid()) {
				try {
					// assert $_POST['city_id'] == $_GET['city_id']
					//$this->table->saveCity({{entity.name|variabilize}});
					$where = [{%for key, table in entity.dbPKColumns %}{%if not loop.first%}, {%endif%}'{{key}}'=>{{entity.name|variabilize}}->{{ key }}{%endfor%}];
					{{entity.name|variabilize}}Rowset = $this->getTable()->update({{entity.name|variabilize}}->getArrayCopy(), $where);
					return $this->redirect()->toRoute('application', ['controller' => '{{entity.name|slugify}}', 'action' => 'index']);
				} catch (\Exception $e) {
					echo '<pre>';
					var_dump('form->isValid, Table->update failled');
					var_dump($e->getMessage());
					print_r($request->getPost());
					print_r({{entity.name|variabilize}}->getArrayCopy());
					echo '</pre>';
					return ['form' => $form];
					//return $this->redirect()->toRoute('application', ['controller' => 'index', 'action' => 'index']);
				}
			} else {
				echo '<pre>';
				var_dump('is invalid');
				print_r($request->getPost());
				print_r($form->getMessages());
				echo '</pre>';
				return ['form' => $form];
			}
		//} else if ($request->isGet()) {
		//} else if ($request->isPut()) {
		//} else if ($request->isDelete()) {
		} else {
			try {
				$where = [{%for key, table in entity.dbPKColumns %}{%if not loop.first%}, {%endif%}'{{key}}'=>${{ key }}{%endfor%}];
				{{entity.name|variabilize}}Rowset = $this->getTable()->select($where);
				{{entity.name|variabilize}}Row = {{entity.name|variabilize}}Rowset->current();
				$form->bind({{entity.name|variabilize}}Row);
				//$form->setData({{entity.name|variabilize}}Row);
				$form->get('submit')->setAttribute('value', 'Edit');
				return ['form' => $form];

			} catch (\Exception $e) {
				var_dump($e->getMessage());
				return ['form' => $form];
				//return $this->redirect()->toRoute('application', ['controller' => '{{entity.name|slugify}}', 'action' => 'index']);
			}
		}
	}

